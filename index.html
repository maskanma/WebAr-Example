<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>WebAR Буклет</title>

  <!-- Three.js та бібліотеки -->
  <script src="js/three.js"></script>
  <script src="js/tween.umd.js"></script>
  <script src="loaders/GLTF2Loader.js"></script>

  <!-- JSARToolkit + Threex -->
  <script src="jsartoolkit5/artoolkit.min.js"></script>
  <script src="jsartoolkit5/artoolkit.api.js"></script>
  <script src="threex/threex-artoolkitsource.js"></script>
  <script src="threex/threex-artoolkitcontext.js"></script>
  <script src="threex/threex-arbasecontrols.js"></script>
  <script src="threex/threex-armarkercontrols.js"></script>
</head>

<body style="margin: 0; overflow: hidden; font-family: sans-serif;">

  <!-- Початковий екран -->
  <div id="access" style="position: absolute; inset: 0; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; text-align: center; z-index: 2;">
    Натисніть на екран для запуску<br>WebAR-буклету "Клавіатура"
  </div>

  <!-- Лоадер -->
  <div id="loader" style="position: absolute; inset: 0; background: #fff; display: none; z-index: 1;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
      <img src="data/spin.gif" alt="Loading..." style="width: 130px; height: 130px;"><br>Завантаження...
    </div>
  </div>

  <script>
    let readyToPlay = false;

    document.getElementById('access').addEventListener('click', () => {
      readyToPlay = true;
      initiateExperience();
      document.getElementById('access').remove();
      document.getElementById('loader').style.display = 'block';
    });

    function initiateExperience() {
      let scene, camera, renderer, clock, deltaTime, totalTime;
      let arToolkitSource, arToolkitContext;
      let mainContainer;
      let contentInitialized = false;
      let barcodesSound = new Map();
      let barcodesID = [1, 2, 3];
      let audioLoader = new THREE.AudioLoader();
      let listener = new THREE.AudioListener();

      // Імена файлів
      const images = ["Screenshot_1.jpg", "Screenshot_2.jpg", "Screenshot_3.jpg"];
      const audios = ["ПІБ Озвучка.ogg", "Автор Озвучка.ogg", "Опис Озвучка.ogg"];
      let contentPromises = [];

      scene = new THREE.Scene();

      camera = new THREE.Camera();
      scene.add(camera);
      camera.add(listener);

      let ambientLight = new THREE.AmbientLight(0xffffff, 0.75);
      scene.add(ambientLight);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setClearColor(new THREE.Color('lightgrey'), 0);
      renderer.setSize(640, 480);
      renderer.domElement.style.position = 'absolute';
      document.body.appendChild(renderer.domElement);

      clock = new THREE.Clock();
      deltaTime = 0;
      totalTime = 0;

      arToolkitSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });

      function onResize() {
        arToolkitSource.onResize();
        arToolkitSource.copySizeTo(renderer.domElement);
        if (arToolkitContext.arController) {
          arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
        }
      }

      arToolkitSource.init(onResize);
      window.addEventListener('resize', onResize);

      arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: 'data/camera_para.dat',
        detectionMode: 'mono_and_matrix',
        matrixCodeType: "3x3",
        canvasWidth: 640,
        canvasHeight: 480
      });

      arToolkitContext.init(() => {
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
      });

      mainContainer = new THREE.Group();
      scene.add(mainContainer);

      // Створення маркерів і контенту
      for (let i = 0; i < 3; i++) {
        let markerRoot = new THREE.Group();
        mainContainer.add(markerRoot);

        new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
          type: "barcode",
          barcodeValue: barcodesID[i]
        });

        // Додавання зображення
        let loader = new THREE.TextureLoader();
        loader.load(images[i], texture => {
          let geometry = new THREE.PlaneBufferGeometry(1, 1);
          let material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
          let mesh = new THREE.Mesh(geometry, material);
          mesh.rotation.x = -Math.PI / 2;
          markerRoot.add(mesh);
        });

        // Завантаження звуку
        contentPromises.push(new Promise((resolve) => {
          audioLoader.load(audios[i], buffer => {
            const sound = new THREE.Audio(listener);
            sound.setBuffer(buffer);
            sound.setLoop(false);
            barcodesSound.set(barcodesID[i], sound);
            resolve();
          });
        }));
      }

      Promise.all(contentPromises).then(() => {
        contentInitialized = true;
        document.getElementById('loader').style.display = 'none';
      });

      function update() {
        if (!arToolkitSource.ready) return;
        arToolkitContext.update(arToolkitSource.domElement);

        if (contentInitialized && readyToPlay) {
          for (let id of barcodesID) {
            let sound = barcodesSound.get(id);
            let isVisible = arToolkitContext.arController.barcodeMarkers[id]?.inCurrent;

            if (sound) {
              if (isVisible && !sound.isPlaying) {
                sound.play();
              } else if (!isVisible && sound.isPlaying) {
                sound.stop();
              }
            }
          }
        }
      }

      function render() {
        renderer.render(scene, camera);
      }

      function animate() {
        requestAnimationFrame(animate);
        deltaTime = clock.getDelta();
        totalTime += deltaTime;
        update();
        render();
      }

      animate();
    }
  </script>
</body>
</html>
